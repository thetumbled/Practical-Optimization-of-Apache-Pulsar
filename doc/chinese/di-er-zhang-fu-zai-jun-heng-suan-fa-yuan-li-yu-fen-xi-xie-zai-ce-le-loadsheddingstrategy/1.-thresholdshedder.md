# 1. ThresholdShedder

ThresholdShedder是默认的Shedding算法，我们优先分析它。

## **1.1 最大资源使用率**

ThresholdShedder 首先使用如下公式计算出每个Broker的最大资源使用率，资源包括CPU、直接内存、网卡入带宽、网卡出带宽。

`org.apache.pulsar.policies.data.loadbalancer.LocalBrokerData#getMaxResourceUsageWithWeight(double, double, double, double)`

<figure><img src="../.gitbook/assets/image (16).png" alt=""><figcaption></figcaption></figure>

资源使用率的计算还可以配置一个权值，由配置loadBalancerBandwidthInResourceWeight、loadBalancerBandwidthOutResourceWeight、loadBalancerCPUResourceWeight、loadBalancerDirectMemoryResourceWeight决定权值大小。

<figure><img src="../.gitbook/assets/image (17).png" alt=""><figcaption></figcaption></figure>

在 2.11 版本之前，负载均衡算法会考虑内存资源的使用率情况。然而，在实践过程中发现，broker 的负载与内存使用率并无明显关联，因此下面PR去掉了它：

[https://github.com/apache/pulsar/pull/19559](https://github.com/apache/pulsar/pull/19559)

实际上，直接内存使用率跟broker的负载也没有明显关联性，因此我提交了如下PR把loadBalancerDirectMemoryResourceWeight的默认值修改为0。

[https://github.com/apache/pulsar/pull/21168](https://github.com/apache/pulsar/pull/21168)

事实上，在负载均衡算法中，所考量的监控指标并非种类越多越好。过多的指标种类，反而容易引发各类意料之外的状况，排查时也会增添诸多麻烦。目前我们只考虑CPU、网卡带宽，这就足够了。



## **1.2 历史权值算法**

计算出来每个Broker的最大资源使用率后，还会执行一个历史权值算法来得到最终的打分。

org.apache.pulsar.broker.loadbalance.impl.ThresholdShedder#updateAvgResourceUsage

















