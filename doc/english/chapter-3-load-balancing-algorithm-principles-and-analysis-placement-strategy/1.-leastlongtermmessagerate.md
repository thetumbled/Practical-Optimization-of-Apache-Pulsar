# 1. LeastLongTermMessageRate

## 1.1 **Scoring Algorithm**

The `LeastLongTermMessageRate` strategy was initially designed to be used in conjunction with `OverloadShedder`. When calculating the load scores for brokers, this strategy does not consider weight configurations (e.g., `loadBalancerCPUResourceWeight`). Instead, it directly uses the maximum resource usage rates for CPU, direct memory, and network as the **initial scores** for brokers. Additionally, it reuses the `loadBalancerBrokerOverloadedThresholdPercentage` configuration from `OverloadShedder`. If the initial score exceeds the default value of 85% for this configuration, the score is set to `INF` (i.e., infinity). Otherwise, the **final score** for the broker is calculated based on the message rate.

Finally, a broker with the smallest final score is randomly selected and returned. If all brokers have a score of INF, a broker is randomly chosen and returned.

**Note:** Since the score is of type `double`, it is highly unlikely that multiple brokers will have the same score. Therefore, it can be considered that the broker with the smallest final score is always selected and returned as the new owner of the bundle.

In essence, the `LeastLongTermMessageRate` scoring algorithm is based on message rate. Although the initial score is derived from the maximum resource usage, its purpose is to initially filter out overloaded brokers, which will not be returned as candidate brokers (unless all brokers are overloaded). Ultimately, the **final score is calculated based on the message rate,** and brokers are ranked according to this final score.

Since the `LeastLongTermMessageRate` scoring is based on message rate, it faces the same issue as `UniformLoadShedder` regarding **heterogeneous environments (i.e., adaptability issues)**.

**:R** As defined in Chapter 1, adaptability issues refer to the inability of the old algorithm to adapt to heterogeneous environments, where higher-performance machines cannot handle more traffic load compared to lower-performance machines.

&#x20;

## **Over Placement Issue**

So, to address the issue of heterogeneous environments, can the \`LeastLongTermMessageRate\` scoring algorithm be adjusted to score based on resource usage?

The answer is no. Before providing a detailed answer to this question, let's first introduce the issue of over placement (as discussed in Chapter 1).

&#x20;

For example, suppose there are currently 11 brokers, all with resource usage around 50%, and the threshold is set to 70%. Since the cluster is not under heavy pressure, an attempt is made to scale down by 3 brokers. Consequently, all bundles on these three brokers will be unloaded and then loaded onto the remaining brokers. Because load data is updated periodically and cannot keep up with the speed of topic lookup and bundle loading (and due to the performance limitations of Zookeeper, it is also impossible to speed up), the load data for each broker in the leader broker's memory can be considered as unupdated in the short term. Therefore, during this period, the broker with the lowest score will always be the same broker, and all bundles will be loaded onto this low-load broker, causing it to become overloaded.

&#x20;

&#x20;

\`LeastLongTermMessageRate\` addresses this issue by using data from \`PreallocatedBundleData\`.

org.apache.pulsar.broker.loadbalance.impl.LeastLongTermMessageRate#getScore













