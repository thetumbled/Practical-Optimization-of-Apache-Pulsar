# 3. UniformLoadShedder

As analyzed earlier, neither `ThresholdShedder` nor `OverloadShedder` can address the issue of resource wastage by brokers with low load. Therefore, `UniformLoadShedder` was introduced.

Note: Although `ThresholdShedder` later added the `lowerBoundaryShedding` feature to address the issue of low-load brokers, this was after the introduction of `UniformLoadShedder`.



## **3.1 Highest and Lowest Loaded Brokers**

Below is a detailed introduction to the `UniformLoadShedder` algorithm. It first calculates the maximum and minimum message rates, maximum and minimum traffic throughput, and the corresponding brokers, as follows:

<figure><img src="../.gitbook/assets/image (20).png" alt=""><figcaption></figcaption></figure>

Then, it calculates the differences between the maximum and minimum values. There are two thresholds, one for message rate and one for throughput size.

<figure><img src="../.gitbook/assets/image (21).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../.gitbook/assets/image (22).png" alt=""><figcaption></figcaption></figure>

**Note**: The data type for both two configuration values is `double`.



<figure><img src="../.gitbook/assets/image (23).png" alt=""><figcaption></figcaption></figure>

*   **loadBalancerMsgRateDifferenceShedderThreshold**: This is the percentage threshold for the difference in message rates between the most loaded and the least loaded brokers. The default value is 50.&#x20;

    * When the maximum message rate is 1.5 times the minimum message rate, bundle unloading can be triggered. For example, if the message rate of Broker 1 is 50K and the message rate of Broker 2 is 30K, the difference is `(50 - 30) / 30 = 66%`. In this case, the load balancer can unload bundles from Broker 1 to Broker 2.
    * Although the configuration description states that this is a percentage value, it can actually exceed 100, allowing for a larger difference between the maximum and minimum message rates. Let the maximum and minimum message rates be X and Y, respectively, and the threshold be P. The trigger condition is:

    <figure><img src="../.gitbook/assets/image (24).png" alt=""><figcaption></figcaption></figure>

    &#x20;       When P is 100, it allows a maximum difference of one times.



*   **loadBalancerMsgThroughputMultiplierDifferenceShedderThreshold**: This is the multiplier threshold for the difference in throughput between the most loaded and the least loaded brokers. The default value is 4.&#x20;

    * When the maximum throughput is four times the minimum throughput, bundle unloading can be triggered. For example, if the throughput of Broker 1 is 450MB and the throughput of Broker 2 is 100MB, the throughput difference is `450 / 100 = 4.5` times. In this case, the load balancer can unload bundles from Broker 1 to Broker 2.
    * If the threshold is configured to a value not greater than 0, shedding based on message rate or throughput will be disabled; if both thresholds are met, shedding will prioritize based on message rate.

    <figure><img src="../.gitbook/assets/image (26).png" alt=""><figcaption></figcaption></figure>

    &#x20;

## **3.2 Selecting Bundles**

Next, calculate the amount of message rate/throughput corresponding to the bundles that need to be unloaded. The algorithm is as follows: **the difference between the maximum and minimum values multiplied by `maxUnloadPercentage`**, with a default value of 0.2.

<figure><img src="../.gitbook/assets/image (27).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../.gitbook/assets/image (28).png" alt=""><figcaption></figcaption></figure>



### **3.2.1 aaBsed on message rate**

**If shedding is based on message rate**,  perform some checks, such as ensuring that the number of bundles on the overloaded broker is greater than 1, and that the total message rate to be unloaded reaches the threshold `minUnloadMessage`, which is configured by default to be 1000.

<figure><img src="../.gitbook/assets/image (30).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../.gitbook/assets/image (31).png" alt=""><figcaption></figcaption></figure>

After passing the checks, start selecting bundles. The selection is also from largest to smallest, but with an additional constraint: the total number of bundles to be unloaded cannot exceed `maxUnloadBundleNumPerShedding`, which is unlimited by default.

<figure><img src="../.gitbook/assets/image (29).png" alt=""><figcaption></figcaption></figure>



* **If shedding is based on throughput**: Similar checks are performed, ensuring that the amount of traffic to be unloaded is at least `minUnloadMessageThroughput`, with a default value of 1MB.

















